## 실행 컨텍스트

### 렉시컬 환경

렉시컬 환경은 키와 값을 갖는 객체 형태의 스코프를 생성하여 식별자를 키로 등록하고 식별자에 바인딩된 값을 관리한다. 즉, 렉시컬 환경은 스코프를 구분하여 식별자를 등록하고 관리하는 저장소 역할을 하는 것이다.

실행 컨텍스트는 **LexicalEnvironment** 와 **variableEnvironment**로 구성됩니다.

실행 컨텍스트 생성 초기에는 두 환경이 동일한 렉시컬 환경을 참조합니다. 이 후 몇가지 상황에 의해서 **VariableEnvironment** 를 위한 새로운 렉시컬 환경을 생성하고 **LexicalEnvironment**와 내용이 달라지는 경우가 있다.

렉시컬 환경은 2개의 컴포넌트로 구성된다.

1. 환경 레코드

   스코프에 포함된 식별자를 등록하고 식별자에 바인딩된 값을 관리하는 저장소이다. 환경 레코드는 소스코드의 타입에 따라 관리하는 내용에 차이는 있습니다.

2. 외부 렉시컬 환경에 대한 참조

   외부 렉시컬 환경에 대한 참조는 상위 스코프를 가리킨다. 이때 상위 스코프란 외부 렉시컬 환경, 즉 해당 실행 컨텍스트를 생성한 소스코드를 포함하는 상위 실행 컨텍스트의 렉시컬 환경을 의미한다. 쉽게 말하면 실행 컨텍스트 스택에서 해당 실행 컨텍스트 기준으로 아래에 쌓여있는 실행 컨텍스트들의 렉시컬 환경이라고 생각하면 된다. 이는 단반향 링크드 리스트로 스코프 체인을 구현합니다.

### 실행 컨텍스트 생성과 식별자 검색

1. 전역 실행 컨텍스트 생성

2. 전역 렉시컬 환경 생성

   전역 렉시컬 환경을 생성하고 전역 실행 컨텍스트에 바인딩한다.

   1. 전역 환경 레코드 생성

      전역 환경 레코드에서는 전역 스코프, 전역 객체, 전역 프로퍼티와 빌트인 전역 함수, 표준 빌트인 객체를 제공한다.

      1. 객체 환경 레코드 생성

         전역코드 평가 과정에서 var 키워드로 선언한 전역 변수화 함수 선언문으로 정의된 전역 함수는 전역 환경 레코드의 객체 환경 레코드에 연결된 BindingObject를 통해 전역 개체의 프로퍼티와 메서드가 된다.

         var로 선언된 변수와 함수를 가지는 환경이다.

      2. 선언적 환경 레코드 생성

         var 키워드로 선언한 전역변수와 함수 선언문으로 정의한 전역 함수 이외의 선언, 즉 let, const 키워드로 선언한 전역 변수는 선언적 환경 레코드에 등록되고 관리된다.

         let과 const는 선언단계와 초기화 단계가 나누어져 있기때문에 초기화 전까지는 참조할 수 가 없습니다. 이를 `temperal dead zone`이 위치에 있다고 표현할 수 있습니다.

   2. this 바인딩

      전역환경 레코드의 내부 슬롯에 this가 바인딩 됩니다. 여기서의 this는 window입니다.

   3. 외부 렉시컬 환경에 대한 참조를 결정

      전역 컨텍스트는 외부 환경이 없기때문에 null입니다.

3. 전역 코드 실행

4. foo함수 코드 평가

   1. 함수 실행 컨텍스트 생성
   2. 함수 렉시컬 환경 생성
      1. 함수 환경 레코드 생성
      2. this 바인딩
      3. 외부 렉시컬 환경에 대한 참조 결정

   자바스크립트는 함수를 어디서 호출했는지가 아니라 어디에 정의했는지에 따라 상위 스코프를 결정한다고 배웠습니다. 그 이유인 즉슨 함수 실행 컨텍스트를 생성할때 함수를 평가하는 단계에서 그 함수의 [[Environment]] 내부 슬롯에 함수의 스코프에 대해 모두 정해지기 때문입니다. 이는 추후에 클로저에 대해 설명할때 중요한 개념이므로 까먹어서는 안되겠습니다.

### 실행 컨텍스트와 블록 레벨 스코프

함수나 전역 객체를 평가하는 와중에 블록을 만나게 되면 블록에 해당하는 새로운 스코프를 참조하게 된다. 그리고 블록이 끊나면 다시 이전 스코프를 참조하게끔 변하게 됩니다.